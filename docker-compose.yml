version: '3.8'

services:
  ttr:
    build: .
    ports:
      - "8080:8080"  # Health check port
      - "9090:9090"  # Metrics port
    environment:
      - TTR_LOG_LEVEL=info
      - TTR_TIMEZONE=UTC
      - ECOBEE_CLIENT_ID=${ECOBEE_CLIENT_ID}
      - ECOBEE_REFRESH_TOKEN=${ECOBEE_REFRESH_TOKEN}
      - ELASTIC_API_KEY=${ELASTIC_API_KEY}
    volumes:
      - ttr-data:/app/data  # Persistent volume for SQLite offset database
    working_dir: /app
    command: /app/bin/thermostat-telemetry-reader -config /app/config.yaml
    networks:
      - ttr-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Optional: Local Elasticsearch for testing
  # elasticsearch:
  #   image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
  #   environment:
  #     - discovery.type=single-node
  #     - xpack.security.enabled=false
  #     - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
  #   ports:
  #     - "9200:9200"
  #     - "9300:9300"
  #   volumes:
  #     - es-data:/usr/share/elasticsearch/data
  #   networks:
  #     - ttr-network
  #   restart: unless-stopped

volumes:
  ttr-data:
    driver: local
    # Persistent storage for SQLite offset tracking database
    # This ensures offset state is maintained across container restarts
  # es-data:
  #   driver: local

networks:
  ttr-network:
    driver: bridge
